<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>åŠ¨ç‰©å›­ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    :root { --primary:#4CAF50; --light:#E8F5E9; --border:#ddd; }
    body { font-family:"Microsoft YaHei",sans-serif; margin:0; padding:20px; background:#f9fdf9; color:#333; line-height:1.5; }
    .container { max-width:1200px; margin:0 auto; }
    header { text-align:center; margin-bottom:30px; padding:20px; background:var(--primary); color:#fff; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    h1 { margin:0; }
    .tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .tab-btn { padding:10px 20px; background:#fff; border:1px solid var(--border); border-radius:6px; cursor:pointer; font-weight:bold; transition:all .3s; }
    .tab-btn:hover, .tab-btn.active { background:var(--primary); color:#fff; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-bottom:20px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    th, td { padding:10px 12px; text-align:left; border-bottom:1px solid var(--border); }
    th { background:var(--light); font-weight:bold; position:sticky; top:0; }
    tr:hover { background:#f9f9f9; }
    .form-section { background:#fff; padding:20px; border-radius:8px; margin-bottom:30px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .form-title { margin-top:0; color:var(--primary); border-left:4px solid var(--primary); padding-left:10px; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; }
    label { display:block; margin-bottom:5px; font-weight:bold; }
    input, select { width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; box-sizing:border-box; }
    .btn { background:var(--primary); color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px; }
    .btn:hover { background:#388E3C; }
    .msg { padding:10px; margin:10px 0; border-radius:4px; display:none; }
    .msg.success { background:#E8F5E9; color:#2E7D32; border:1px solid #A5D6A7; }
    .msg.error { background:#FFEBEE; color:#C62828; border:1px solid #EF9A9A; }
    .row-actions { display:flex; gap:8px; flex-wrap:wrap; }
    footer { text-align:center; margin-top:40px; color:#777; font-size:14px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ˜ åŠ¨ç‰©å›­ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</h1>
      <div id="authBar" style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center;">
        <span id="authStatus">æœªç™»å½•</span>
        <input id="loginUser" placeholder="ç”¨æˆ·å" style="max-width:160px;">
        <input id="loginPwd" type="password" placeholder="å¯†ç " style="max-width:160px;">
        <button class="btn" id="btnLogin">ç™»å½•</button>
        <button class="btn" id="btnLogout" style="display:none;">é€€å‡º</button>
        <div id="authMsg" class="msg" style="margin:0;"> </div>
      </div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="enclosure">å±•åŒºä¿¡æ¯</button>
      <button class="tab-btn" data-tab="animal">åŠ¨ç‰©ä¿¡æ¯</button>
      <button class="tab-btn" data-tab="staff">å‘˜å·¥ä¿¡æ¯</button>
      <button class="tab-btn" data-tab="feed">é¥²æ–™ä¿¡æ¯</button>
      <button class="tab-btn" data-tab="feeding">æŠ•å–‚è®°å½•</button>
    </div>

    <div id="enclosure" class="tab-content active">
      <div class="form-section">
        <h3 class="form-title">ğŸŸ¢ æ–°å¢å±•åŒº</h3>
        <div class="form-grid">
          <div><label>å±•åŒºç¼–å·</label><input id="enid" placeholder="å¦‚ E001"></div>
          <div><label>åç§°</label><input id="ename" placeholder="å¦‚ çŒ´å±±"></div>
          <div><label>å®¹é‡</label><input id="ecapacity" type="number" placeholder="å¦‚ 20"></div>
          <div><label>çŠ¶æ€</label>
            <select id="estatus">
              <option value="å¯ç”¨">å¯ç”¨</option>
              <option value="ç»´æŠ¤ä¸­">ç»´æŠ¤ä¸­</option>
              <option value="å…³é—­">å…³é—­</option>
            </select>
          </div>
          <div><label>è¯´æ˜</label><input id="edesc" placeholder="å¯é€‰"></div>
        </div>
        <button class="btn" id="btnAddEnclosure">â• æ·»åŠ å±•åŒº</button>
        <div id="enclosureMsg" class="msg"></div>
      </div>
      <h3>ğŸ“‹ å±•åŒºåˆ—è¡¨</h3>
      <table id="enclosureTable"><thead><tr><th>å±•åŒºç¼–å·</th><th>åç§°</th><th>å®¹é‡</th><th>å½“å‰åŠ¨ç‰©æ•°</th><th>çŠ¶æ€</th><th>è¯´æ˜</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="animal" class="tab-content">
      <div class="form-section">
        <h3 class="form-title">ğŸ’ æ–°å¢åŠ¨ç‰©</h3>
        <div class="form-grid">
          <div><label>åŠ¨ç‰©ç¼–å·</label><input id="anid" placeholder="å¦‚ A001"></div>
          <div><label>åå­—</label><input id="aname" placeholder="å¦‚ ä¹ä¹"></div>
          <div><label>ç§ç±»</label><input id="aspecies" placeholder="å¦‚ é‡‘ä¸çŒ´"></div>
          <div><label>æ€§åˆ«</label>
            <select id="agender">
              <option value="M">M é›„æ€§</option>
              <option value="F">F é›Œæ€§</option>
            </select>
          </div>
          <div><label>å‡ºç”Ÿæ—¥æœŸ</label><input id="abirth" type="date"></div>
          <div><label>æ‰€åœ¨å±•åŒº</label><select id="aenid"></select></div>
        </div>
        <button class="btn" id="btnAddAnimal">â• æ·»åŠ åŠ¨ç‰©</button>
        <div id="animalMsg" class="msg"></div>
      </div>
      <h3>ğŸ“‹ åŠ¨ç‰©åˆ—è¡¨</h3>
      <table id="animalTable"><thead><tr><th>åŠ¨ç‰©ç¼–å·</th><th>åå­—</th><th>ç§ç±»</th><th>æ€§åˆ«</th><th>å‡ºç”Ÿæ—¥æœŸ</th><th>æ‰€åœ¨å±•åŒº</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="staff" class="tab-content">
      <div class="form-section">
        <h3 class="form-title">ğŸ‘· æ–°å¢å‘˜å·¥</h3>
        <div class="form-grid">
          <div><label>å‘˜å·¥ç¼–å·</label><input id="sid" placeholder="å¦‚ EMP001"></div>
          <div><label>å§“å</label><input id="sname" placeholder="å¦‚ å¼ ä¼Ÿ"></div>
          <div><label>èŒä½</label>
            <select id="srole">
              <option value="é¥²å…»å‘˜">é¥²å…»å‘˜</option>
              <option value="å…½åŒ»">å…½åŒ»</option>
              <option value="ç®¡ç†å‘˜">ç®¡ç†å‘˜</option>
              <option value="è®²è§£å‘˜">è®²è§£å‘˜</option>
            </select>
          </div>
          <div><label>è´Ÿè´£å±•åŒº</label><select id="senid"></select></div>
          <div><label>å…¥èŒæ—¥æœŸ</label><input id="shire" type="date"></div>
          <div><label>ç”µè¯</label><input id="sphone" placeholder="å¯é€‰"></div>
          <div><label>é‚®ç®±</label><input id="semail" placeholder="å¯é€‰"></div>
        </div>
        <button class="btn" id="btnAddStaff">â• æ·»åŠ å‘˜å·¥</button>
        <div id="staffMsg" class="msg"></div>
      </div>
      <h3>ğŸ“‹ å‘˜å·¥åˆ—è¡¨</h3>
      <table id="staffTable"><thead><tr><th>å‘˜å·¥ç¼–å·</th><th>å§“å</th><th>èŒä½</th><th>è´Ÿè´£å±•åŒº</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="feed" class="tab-content">
      <div class="form-section">
        <h3 class="form-title">ğŸ¥œ æ–°å¢é¥²æ–™</h3>
        <div class="form-grid">
          <div><label>é¥²æ–™ç¼–å·</label><input id="fid" placeholder="å¦‚ F001"></div>
          <div><label>åç§°</label><input id="fname" placeholder="å¦‚ é¦™è•‰"></div>
          <div><label>ç±»åˆ«</label><input id="fcat" placeholder="å¦‚ æ°´æœ"></div>
          <div><label>åº“å­˜æ•°é‡</label><input id="fstock" type="number" step="0.1" placeholder="å¦‚ 100"></div>
          <div><label>å•ä½</label>
            <select id="funit">
              <option value="kg">kg</option>
              <option value="åŒ…">åŒ…</option>
              <option value="æ ¹">æ ¹</option>
            </select>
          </div>
        </div>
        <button class="btn" id="btnAddFeed">â• æ·»åŠ é¥²æ–™</button>
        <div id="feedMsg" class="msg"></div>
      </div>
      <h3>ğŸ“‹ é¥²æ–™åˆ—è¡¨</h3>
      <table id="feedTable"><thead><tr><th>é¥²æ–™ç¼–å·</th><th>åç§°</th><th>åº“å­˜æ•°é‡</th><th>å•ä½</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="feeding" class="tab-content">
      <div class="form-section">
        <h3 class="form-title">ğŸ¥£ æ–°å¢æŠ•å–‚è®°å½•</h3>
        <div class="form-grid">
          <div><label>æ—¶é—´</label><input id="ftime" type="datetime-local"></div>
          <div><label>åŠ¨ç‰©</label><select id="fanimal"></select></div>
          <div><label>é¥²æ–™</label><select id="ffeed"></select></div>
          <div><label>å‘˜å·¥</label><select id="femployee"></select></div>
          <div><label>æ•°é‡</label><input id="fquantity" type="number" step="0.1" placeholder="å¦‚ 2.5"></div>
          <div><label>å¤‡æ³¨</label><input id="fnotes" placeholder="å¯é€‰"></div>
        </div>
        <button class="btn" id="btnAddFeeding">â• æ·»åŠ è®°å½•</button>
        <div id="feedingMsg" class="msg"></div>
      </div>
      <h3>ğŸ“‹ æŠ•å–‚è®°å½•</h3>
      <table id="feedingTable"><thead><tr><th>è®°å½•ID</th><th>æ—¶é—´</th><th>åŠ¨ç‰©</th><th>é¥²æ–™</th><th>å‘˜å·¥</th><th>æ•°é‡</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <footer>ğŸ“ æ•°æ®åº“è¯¾ç¨‹è®¾è®¡ tree-big-jeans å°ç»„</footer>
  </div>

  <script>
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    function showMessage(id, text, type) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = 'msg ' + type;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    const API_BASE = (location.protocol === 'http:' || location.protocol === 'https:') ? '' : 'http://localhost:8080';
    function getToken(){ try { return sessionStorage.getItem('zoo_token') || localStorage.getItem('zoo_token') || ''; } catch(e){ return ''; } }
    function getUser(){ try { return { userId: sessionStorage.getItem('zoo_userId') || localStorage.getItem('zoo_userId') || '', role: sessionStorage.getItem('zoo_role') || localStorage.getItem('zoo_role') || '', username: sessionStorage.getItem('zoo_username') || localStorage.getItem('zoo_username') || '' }; } catch(e){ return {userId:'',role:'',username:''}; } }
    function clearToken(){ try { ['zoo_token','zoo_userId','zoo_role','zoo_username'].forEach(k=>{ localStorage.removeItem(k); sessionStorage.removeItem(k); }); } catch(e){} }
    function applyAuthUI(){ const t = getToken(); const st = document.getElementById('authStatus'); const lo = document.getElementById('btnLogout'); const li = document.getElementById('btnLogin'); const u = document.getElementById('loginUser'); const p = document.getElementById('loginPwd'); const info = getUser(); if(t){ st.textContent = `å·²ç™»å½•ï¼š${info.username||info.userId}ï¼ˆ${info.role||'æœªçŸ¥è§’è‰²'}ï¼‰`; lo.style.display='inline-block'; li.style.display='none'; u.style.display='none'; p.style.display='none'; applyRoleUI(info.role); } else { st.textContent = 'æœªç™»å½•'; lo.style.display='none'; li.style.display='inline-block'; u.style.display='inline-block'; p.style.display='inline-block'; } }
    async function request(method, path, body){
      const r = await fetch(API_BASE + path, {
        method,
        headers: (()=>{ const h = {}; if (body !== undefined) h['Content-Type']='application/json'; const t = getToken(); if(t) h['Authorization']='Bearer '+t; return h; })(),
        body: body !== undefined ? JSON.stringify(body) : undefined
      });
      if (!r.ok) {
        let payload = null;
        try { payload = await r.json(); } catch(e) {}
        const msg = (payload && (payload.message || payload.error)) || r.statusText || 'è¯·æ±‚å¤±è´¥';
        const err = new Error(msg);
        err.status = r.status;
        err.payload = payload;
        throw err;
      }
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) return r.json();
      if (r.status === 204) return null;
      return r.text();
    }
    const api = {
      get: (path) => request('GET', path),
      post: (path, body) => request('POST', path, body),
      put: (path, body) => request('PUT', path, body),
      del: (path) => request('DELETE', path)
    };

    async function loadAll() {
      try {
        const [ens, animals, emps, feeds, feedings] = await Promise.all([
          api.get('/api/enclosures'),
          api.get('/api/animals'),
          api.get('/api/employees'),
          api.get('/api/feeds'),
          api.get('/api/feedings')
        ]);
        renderEnclosures(ens);
        renderAnimals(animals, ens);
        renderEmployees(emps, ens);
        renderFeeds(feeds);
        renderFeeding(feedings);
        populateSelect('#aenid', ens.map(e=>({value:e.enclosureId,text:`${e.name} (${e.enclosureId})`})));
        populateSelect('#senid', ens.map(e=>({value:e.enclosureId,text:`${e.name} (${e.enclosureId})`})));
        populateSelect('#fanimal', animals.map(a=>({value:a.animalId,text:`${a.name} (${a.animalId})`})));
        populateSelect('#ffeed', feeds.map(f=>({value:f.feedId,text:`${f.name} (${f.feedId})`})));
        populateSelect('#femployee', emps.map(s=>({value:s.employeeId,text:`${s.name} (${s.employeeId})`})));
      } catch(err){ console.error(err); showMessage('enclosureMsg', 'æ•°æ®åŠ è½½å¤±è´¥: '+(err.message||'æ— æ³•è¿æ¥åç«¯'), 'error'); }
    }

    function populateSelect(sel, options){ const el = document.querySelector(sel); el.innerHTML = ''; options.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.text; el.appendChild(opt); }); }

    function renderEnclosures(list){ const tbody = document.querySelector('#enclosureTable tbody'); tbody.innerHTML=''; list.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${e.enclosureId}</td><td>${e.name}</td><td>${e.capacity}</td><td>${e.currentAnimalCount||0}</td><td>${e.status||''}</td><td>${e.description||''}</td><td class="row-actions"><button class="btn" data-del="${e.enclosureId}">åˆ é™¤</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('button[data-del]').forEach(btn=>btn.addEventListener('click', async () => { try { await api.del('/api/enclosures/'+btn.dataset.del); loadAll(); } catch(err){ showMessage('enclosureMsg', 'åˆ é™¤å¤±è´¥: '+(err.message||'é”™è¯¯'), 'error'); } })); }

    function renderAnimals(list, ens){ const role = getUser().role; const tbody = document.querySelector('#animalTable tbody'); tbody.innerHTML=''; list.forEach(a=>{ const tr=document.createElement('tr'); const encSel = document.createElement('select'); ens.forEach(e=>{ const opt=document.createElement('option'); opt.value=e.enclosureId; opt.textContent=`${e.name} (${e.enclosureId})`; if(e.enclosureId===a.enclosureId) opt.selected=true; encSel.appendChild(opt); }); const tdOps = document.createElement('td'); tdOps.className='row-actions'; if(role !== 'staff'){ const transferBtn = document.createElement('button'); transferBtn.className='btn'; transferBtn.textContent='è½¬ç§»'; transferBtn.addEventListener('click', async ()=>{ try { await api.post(`/api/animals/${a.animalId}/transfer?targetEnclosureId=${encodeURIComponent(encSel.value)}`, {}); loadAll(); } catch(err){ showMessage('animalMsg', 'è½¬ç§»å¤±è´¥: '+(err.message||'é”™è¯¯'), 'error'); } }); const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='åˆ é™¤'; delBtn.addEventListener('click', async ()=>{ try { await api.del('/api/animals/'+a.animalId); loadAll(); } catch(err){ showMessage('animalMsg', 'åˆ é™¤å¤±è´¥: '+(err.message||'é”™è¯¯'), 'error'); } }); tdOps.appendChild(transferBtn); tdOps.appendChild(delBtn); }
      tr.innerHTML = `<td>${a.animalId}</td><td>${a.name}</td><td>${a.species}</td><td>${a.gender}</td><td>${a.birthDate||''}</td><td></td>`; const tdEnc = tr.querySelectorAll('td')[5]; tdEnc.appendChild(encSel); tr.appendChild(tdOps); tbody.appendChild(tr); }); }

    function renderEmployees(list, ens){ const role = getUser().role; const tbody = document.querySelector('#staffTable tbody'); tbody.innerHTML=''; list.forEach(s=>{ const tr=document.createElement('tr'); const encSel=document.createElement('select'); ens.forEach(e=>{ const opt=document.createElement('option'); opt.value=e.enclosureId; opt.textContent=`${e.name} (${e.enclosureId})`; if(e.enclosureId===s.enclosureId) opt.selected=true; encSel.appendChild(opt); }); const ops=document.createElement('td'); ops.className='row-actions'; if(role !== 'staff'){ const assignBtn=document.createElement('button'); assignBtn.className='btn'; assignBtn.textContent='åˆ†é…å±•åŒº'; assignBtn.addEventListener('click', async ()=>{ try { await api.post(`/api/employees/${s.employeeId}/assign-enclosure?enclosureId=${encodeURIComponent(encSel.value)}`, {}); loadAll(); } catch(err){ showMessage('staffMsg', 'åˆ†é…å¤±è´¥: '+(err.message||'é”™è¯¯'), 'error'); } }); const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='åˆ é™¤'; delBtn.addEventListener('click', async ()=>{ try { await api.del('/api/employees/'+s.employeeId); loadAll(); } catch(err){ showMessage('staffMsg', 'åˆ é™¤å¤±è´¥: '+(err.message||'é”™è¯¯'), 'error'); } }); ops.appendChild(assignBtn); ops.appendChild(delBtn); }
      tr.innerHTML = `<td>${s.employeeId}</td><td>${s.name}</td><td>${s.position}</td><td></td>`; tr.querySelectorAll('td')[3].appendChild(encSel); tr.appendChild(ops); tbody.appendChild(tr); }); }

    function renderFeeds(list){ const role = getUser().role; const tbody = document.querySelector('#feedTable tbody'); tbody.innerHTML=''; list.forEach(f=>{ const tr=document.createElement('tr'); const ops=document.createElement('td'); ops.className='row-actions'; if(role !== 'staff'){ const incBtn=document.createElement('button'); incBtn.className='btn'; incBtn.textContent='+1'; incBtn.addEventListener('click', async ()=>{ try { await api.post(`/api/feeds/${f.feedId}/increase?qty=1`, {}); loadAll(); } catch(err){ showMessage('feedMsg','å¢åŠ å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); } }); const decBtn=document.createElement('button'); decBtn.className='btn'; decBtn.textContent='-1'; decBtn.addEventListener('click', async ()=>{ try { await api.post(`/api/feeds/${f.feedId}/decrease?qty=1`, {}); loadAll(); } catch(err){ showMessage('feedMsg','å‡å°‘å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); } }); const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='åˆ é™¤'; delBtn.addEventListener('click', async ()=>{ try { await api.del('/api/feeds/'+f.feedId); loadAll(); } catch(err){ showMessage('feedMsg','åˆ é™¤å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); } }); ops.appendChild(incBtn); ops.appendChild(decBtn); ops.appendChild(delBtn); }
      tr.innerHTML = `<td>${f.feedId}</td><td>${f.name}</td><td>${(f.stockQuantity??0)}</td><td>${f.unit}</td>`; tr.appendChild(ops); tbody.appendChild(tr); }); }

    function renderFeeding(list){ const role = getUser().role; const user = getUser(); const tbody=document.querySelector('#feedingTable tbody'); tbody.innerHTML=''; list.forEach(r=>{ const tr=document.createElement('tr'); const ops=document.createElement('td'); ops.className='row-actions'; if(role !== 'staff'){ const approveBtn=document.createElement('button'); approveBtn.className='btn'; approveBtn.textContent='é€šè¿‡'; approveBtn.addEventListener('click', async ()=>{ try { await api.post(`/api/feedings/${r.recordId}/approve?verifierId=${encodeURIComponent(user.userId)}`, {}); loadAll(); } catch(err){ showMessage('feedingMsg','å®¡æ‰¹å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); } }); const rejectBtn=document.createElement('button'); rejectBtn.className='btn'; rejectBtn.textContent='æ‹’ç»'; rejectBtn.addEventListener('click', async ()=>{ try { await api.post(`/api/feedings/${r.recordId}/reject?verifierId=${encodeURIComponent(user.userId)}`, {}); loadAll(); } catch(err){ showMessage('feedingMsg','é©³å›å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); } }); ops.appendChild(approveBtn); ops.appendChild(rejectBtn); }
      tr.innerHTML = `<td>${r.recordId||''}</td><td>${r.feedingTime? r.feedingTime.replace('T',' ').replace('Z',''): ''}</td><td>${r.animalId}</td><td>${r.feedId}</td><td>${r.employeeId}</td><td>${r.quantity}</td><td>${r.status||''}</td>`; tr.appendChild(ops); tbody.appendChild(tr); }); }

    document.getElementById('btnAddEnclosure').addEventListener('click', async () => {
      const enid = document.getElementById('enid').value.trim();
      const ename = document.getElementById('ename').value.trim();
      const ecapacity = parseInt(document.getElementById('ecapacity').value,10);
      const estatus = document.getElementById('estatus').value;
      const edesc = document.getElementById('edesc').value.trim();
      if(!enid || !ename || !ecapacity){ return showMessage('enclosureMsg','âš ï¸ å±•åŒºç¼–å·ã€åç§°ã€å®¹é‡ä¸èƒ½ä¸ºç©º','error'); }
      try {
        await api.post('/api/enclosures', { enclosureId: enid, name: ename, capacity: ecapacity, currentAnimalCount: 0, status: estatus, description: edesc });
        showMessage('enclosureMsg','âœ… å±•åŒºæ·»åŠ æˆåŠŸï¼','success');
        document.getElementById('enid').value=''; document.getElementById('ename').value=''; document.getElementById('ecapacity').value=''; document.getElementById('edesc').value='';
        loadAll();
      } catch(err){ showMessage('enclosureMsg','æ·»åŠ å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); }
    });

    document.getElementById('btnAddAnimal').addEventListener('click', async () => {
      const anid = document.getElementById('anid').value.trim();
      const aname = document.getElementById('aname').value.trim();
      const aspecies = document.getElementById('aspecies').value.trim();
      const agender = document.getElementById('agender').value;
      const abirth = document.getElementById('abirth').value;
      const aenid = document.getElementById('aenid').value;
      if(!anid || !aname || !aspecies || !aenid){ return showMessage('animalMsg','âš ï¸ åŠ¨ç‰©ç¼–å·ã€åå­—ã€ç§ç±»ã€å±•åŒºå¿…å¡«','error'); }
      try {
        await api.post('/api/animals', { animalId: anid, name: aname, species: aspecies, gender: agender, birthDate: abirth || null, enclosureId: aenid });
        showMessage('animalMsg','âœ… åŠ¨ç‰©æ·»åŠ æˆåŠŸï¼','success');
        document.getElementById('anid').value=''; document.getElementById('aname').value=''; document.getElementById('aspecies').value=''; document.getElementById('abirth').value='';
        loadAll();
      } catch(err){ showMessage('animalMsg','æ·»åŠ å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); }
    });

    document.getElementById('btnAddStaff').addEventListener('click', async () => {
      const sid = document.getElementById('sid').value.trim();
      const sname = document.getElementById('sname').value.trim();
      const srole = document.getElementById('srole').value;
      const senid = document.getElementById('senid').value || null;
      const shire = document.getElementById('shire').value || null;
      const sphone = document.getElementById('sphone').value.trim();
      const semail = document.getElementById('semail').value.trim();
      if(!sid || !sname || !srole){ return showMessage('staffMsg','âš ï¸ å‘˜å·¥ç¼–å·ã€å§“åã€èŒä½å¿…å¡«','error'); }
      try {
        await api.post('/api/employees', { employeeId: sid, name: sname, position: srole, enclosureId: senid, hireDate: shire, phone: sphone||null, email: semail||null });
        showMessage('staffMsg','âœ… å‘˜å·¥æ·»åŠ æˆåŠŸï¼','success');
        document.getElementById('sid').value=''; document.getElementById('sname').value=''; document.getElementById('sphone').value=''; document.getElementById('semail').value='';
        loadAll();
      } catch(err){ showMessage('staffMsg','æ·»åŠ å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); }
    });

    document.getElementById('btnAddFeed').addEventListener('click', async () => {
      const fid = document.getElementById('fid').value.trim();
      const fname = document.getElementById('fname').value.trim();
      const fcat = document.getElementById('fcat').value.trim();
      const fstock = document.getElementById('fstock').value;
      const funit = document.getElementById('funit').value;
      if(!fid || !fname || fstock === ''){ return showMessage('feedMsg','âš ï¸ é¥²æ–™ç¼–å·ã€åç§°ã€åº“å­˜å¿…å¡«','error'); }
      try {
        await api.post('/api/feeds', { feedId: fid, name: fname, category: fcat||null, stockQuantity: parseFloat(fstock), unit: funit });
        showMessage('feedMsg','âœ… é¥²æ–™æ·»åŠ æˆåŠŸï¼','success');
        document.getElementById('fid').value=''; document.getElementById('fname').value=''; document.getElementById('fcat').value=''; document.getElementById('fstock').value='';
        loadAll();
      } catch(err){ showMessage('feedMsg','æ·»åŠ å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); }
    });

    document.getElementById('btnAddFeeding').addEventListener('click', async () => {
      const ftime = document.getElementById('ftime').value;
      const fanimal = document.getElementById('fanimal').value;
      const ffeed = document.getElementById('ffeed').value;
      const femployee = document.getElementById('femployee').value;
      const fquantity = document.getElementById('fquantity').value;
      const fnotes = document.getElementById('fnotes').value.trim();
      if(!fanimal || !ffeed || !femployee || fquantity === ''){ return showMessage('feedingMsg','âš ï¸ æ‰€æœ‰å­—æ®µå¿…å¡«','error'); }
      try {
        await api.post('/api/feedings', { animalId: fanimal, feedId: ffeed, employeeId: femployee, quantity: parseFloat(fquantity), notes: fnotes||null });
        showMessage('feedingMsg','âœ… æŠ•å–‚è®°å½•æ·»åŠ æˆåŠŸï¼','success');
        document.getElementById('fquantity').value=''; document.getElementById('fnotes').value='';
        loadAll();
      } catch(err){ showMessage('feedingMsg','æ·»åŠ å¤±è´¥: '+(err.message||'é”™è¯¯'),'error'); }
    });

    document.getElementById('btnLogin').addEventListener('click', ()=>{ location.href = '/login.html'; });
    document.getElementById('btnLogout').addEventListener('click', ()=>{ clearToken(); applyAuthUI(); });

    window.onload = () => {
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      document.getElementById('ftime').value = local;
      const t = getToken();
      if(!t){ location.href = '/login.html'; return; }
      applyAuthUI();
      loadAll();
    };

    function applyRoleUI(role){
      const tabs = {
        enclosure: document.querySelector('button[data-tab="enclosure"]'),
        animal: document.querySelector('button[data-tab="animal"]'),
        staff: document.querySelector('button[data-tab="staff"]'),
        feed: document.querySelector('button[data-tab="feed"]'),
        feeding: document.querySelector('button[data-tab="feeding"]')
      };
      const isSuper = role === 'super_admin';
      const isAdmin = role === 'admin';
      const isStaff = role === 'staff';
      if(isStaff){
        tabs.enclosure.style.display = 'none';
        tabs.staff.style.display = 'none';
        tabs.feed.style.display = 'inline-block';
        tabs.animal.style.display = 'inline-block';
        tabs.feeding.style.display = 'inline-block';
      } else if(isAdmin){
        tabs.enclosure.style.display = 'inline-block';
        tabs.staff.style.display = 'inline-block';
        tabs.feed.style.display = 'inline-block';
        tabs.animal.style.display = 'inline-block';
        tabs.feeding.style.display = 'inline-block';
      } else if(isSuper){
        tabs.enclosure.style.display = 'inline-block';
        tabs.staff.style.display = 'inline-block';
        tabs.feed.style.display = 'inline-block';
        tabs.animal.style.display = 'inline-block';
        tabs.feeding.style.display = 'inline-block';
      }
    }
  </script>
</body>
</html>
